name: Deploy to Azure

on:
  # æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      resource_group:
        description: 'Azure è³‡æºç¾¤çµ„åç¨±'
        required: true
        type: string

  # è‡ªå‹•éƒ¨ç½²ï¼ˆç•¶ main åˆ†æ”¯æœ‰æ–°ç‰ˆæœ¬æ™‚ï¼‰
  push:
    branches:
      - main
    tags:
      - 'v*'

  # æˆ–ç•¶æˆåŠŸå»ºç½®æ˜ åƒå¾Œ
  workflow_run:
    workflows: ["Pipeline"]
    types:
      - completed
    branches:
      - main

env:
  # Azure é…ç½®
  DEFAULT_LOCATION: swedencentral
  COGNITIVE_COMMUNICATION_LOCATION: westeurope
  OPENAI_LOCATION: swedencentral
  SEARCH_LOCATION: francecentral

  # Container é…ç½®
  CONTAINER_REGISTRY: ghcr.io
  CONTAINER_NAME: ${{ github.repository }}

permissions:
  id-token: write
  contents: read
  packages: read

jobs:
  # æ±ºå®šéƒ¨ç½²ç’°å¢ƒ
  setup:
    name: Setup Deployment
    runs-on: ubuntu-24.04
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      resource_group: ${{ steps.determine-env.outputs.resource_group }}
      image_version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Determine environment
        id: determine-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "resource_group=${{ inputs.resource_group }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "resource_group=call-center-ai-prod" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "resource_group=call-center-ai-dev" >> $GITHUB_OUTPUT
          fi

      - name: Generate version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(bash cicd/version/version.sh -g . -c)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # éƒ¨ç½²åŸºç¤è¨­æ–½
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-24.04
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      app_url: ${{ steps.deploy.outputs.app_url }}
      blob_storage_name: ${{ steps.deploy.outputs.blob_storage_name }}
      container_app_name: ${{ steps.deploy.outputs.container_app_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Azure Login (OIDC)
        uses: azure/login@v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Show current subscription
        run: |
          echo "ğŸ“‹ éƒ¨ç½²è³‡è¨Š:"
          echo "  ç’°å¢ƒ: ${{ needs.setup.outputs.environment }}"
          echo "  è³‡æºç¾¤çµ„: ${{ needs.setup.outputs.resource_group }}"
          echo "  æ˜ åƒç‰ˆæœ¬: ${{ needs.setup.outputs.image_version }}"
          echo ""
          echo "â˜ï¸ Azure è¨‚é–±:"
          az account show --query "{subscriptionId:id, subscriptionName:name, tenantId:tenantId}" --output table

      - name: Deploy Bicep template
        id: deploy
        run: |
          echo "ğŸš€ éƒ¨ç½² Azure è³‡æº..."

          DEPLOYMENT_OUTPUT=$(az deployment sub create \
            --location ${{ env.DEFAULT_LOCATION }} \
            --name ${{ needs.setup.outputs.resource_group }} \
            --parameters \
              cognitiveCommunicationLocation=${{ env.COGNITIVE_COMMUNICATION_LOCATION }} \
              imageVersion=${{ needs.setup.outputs.image_version }} \
              instance=${{ needs.setup.outputs.resource_group }} \
              openaiLocation=${{ env.OPENAI_LOCATION }} \
              searchLocation=${{ env.SEARCH_LOCATION }} \
              promptContentFilter=true \
            --template-file cicd/bicep/main.bicep \
            --output json)

          echo "âœ… éƒ¨ç½²å®Œæˆ"

          # æå–è¼¸å‡º
          APP_URL=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.appUrl.value')
          BLOB_STORAGE=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.blobStoragePublicName.value')
          CONTAINER_APP=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.containerAppName.value')

          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "blob_storage_name=$BLOB_STORAGE" >> $GITHUB_OUTPUT
          echo "container_app_name=$CONTAINER_APP" >> $GITHUB_OUTPUT

          echo "ğŸ“ æ‡‰ç”¨ç¨‹å¼ URL: $APP_URL"

      - name: Wait for deployment
        run: |
          echo "â³ ç­‰å¾…è³‡æºå®Œå…¨å°±ç·’..."
          sleep 30

  # ä¸Šå‚³éœæ…‹è³‡æº
  deploy-static-assets:
    name: Deploy Static Assets
    runs-on: ubuntu-24.04
    needs:
      - setup
      - deploy-infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Azure Login
        uses: azure/login@v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Upload public resources
        run: |
          echo "ğŸ“¦ ä¸Šå‚³éœæ…‹è³‡æºåˆ° Blob Storage..."

          az storage blob upload-batch \
            --account-name ${{ needs.deploy-infrastructure.outputs.blob_storage_name }} \
            --auth-mode login \
            --destination '$web' \
            --no-progress \
            --overwrite \
            --source public

          echo "âœ… éœæ…‹è³‡æºä¸Šå‚³å®Œæˆ"

  # éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼é…ç½®
  deploy-config:
    name: Deploy Application Config
    runs-on: ubuntu-24.04
    needs:
      - setup
      - deploy-infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Azure Login
        uses: azure/login@v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Container App with config
        run: |
          echo "âš™ï¸ æ›´æ–°æ‡‰ç”¨ç¨‹å¼é…ç½®..."

          # é€™è£¡å¯ä»¥æ·»åŠ é…ç½®æ›´æ–°é‚è¼¯
          # ä¾‹å¦‚ï¼šå¾ Azure Key Vault ç²å–secretsï¼Œæ›´æ–°ç’°å¢ƒè®Šæ•¸ç­‰

          echo "âœ… é…ç½®æ›´æ–°å®Œæˆ"

  # å¥åº·æª¢æŸ¥
  health-check:
    name: Health Check
    runs-on: ubuntu-24.04
    needs:
      - setup
      - deploy-infrastructure
      - deploy-static-assets
      - deploy-config
    steps:
      - name: Wait for app to start
        run: |
          echo "â³ ç­‰å¾…æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•..."
          sleep 60

      - name: Check liveness
        run: |
          echo "ğŸ¥ æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼å¥åº·ç‹€æ…‹..."

          APP_URL="${{ needs.deploy-infrastructure.outputs.app_url }}"
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "å˜—è©¦ $((RETRY_COUNT + 1))/$MAX_RETRIES..."

            if curl -f -s -o /dev/null "$APP_URL/health/liveness"; then
              echo "âœ… Liveness æª¢æŸ¥é€šé"
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ ç­‰å¾… 10 ç§’å¾Œé‡è©¦..."
              sleep 10
            else
              echo "âŒ Liveness æª¢æŸ¥å¤±æ•—"
              exit 1
            fi
          done

      - name: Check readiness
        run: |
          echo "ğŸ” æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼å°±ç·’ç‹€æ…‹..."

          APP_URL="${{ needs.deploy-infrastructure.outputs.app_url }}"

          if curl -f -s "$APP_URL/health/readiness" | jq -e '.status == "ok"' > /dev/null; then
            echo "âœ… Readiness æª¢æŸ¥é€šé"
          else
            echo "âŒ Readiness æª¢æŸ¥å¤±æ•—"
            exit 1
          fi

  # éƒ¨ç½²æ‘˜è¦
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-24.04
    needs:
      - setup
      - deploy-infrastructure
      - health-check
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ğŸš€ éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ éƒ¨ç½²è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "- **ç’°å¢ƒ**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è³‡æºç¾¤çµ„**: ${{ needs.setup.outputs.resource_group }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜ åƒç‰ˆæœ¬**: ${{ needs.setup.outputs.image_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¸ç™¼è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”— è³‡æºé€£çµ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‡‰ç”¨ç¨‹å¼ URL**: ${{ needs.deploy-infrastructure.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¥åº·æª¢æŸ¥**: ${{ needs.deploy-infrastructure.outputs.app_url }}/health/liveness" >> $GITHUB_STEP_SUMMARY
          echo "- **API æ–‡æª”**: ${{ needs.deploy-infrastructure.outputs.app_url }}/docs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.health-check.result }}" == "success" ]]; then
            echo "## âœ… éƒ¨ç½²ç‹€æ…‹: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ éƒ¨ç½²ç‹€æ…‹: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" >> $GITHUB_STEP_SUMMARY

      - name: Post deployment notification
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ æ‡‰ç”¨ç¨‹å¼: ${{ needs.deploy-infrastructure.outputs.app_url }}"
          echo "ğŸ“Š ç›£æ§: https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ needs.setup.outputs.resource_group }}"
